<!--_meta 作为公共模版分离出去-->
<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8">
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<LINK rel="Bookmark" href="/favicon.ico" >
<LINK rel="Shortcut Icon" href="/favicon.ico" />
<!--[if lt IE 9]>
<script type="text/javascript" src="lib/html5.js"></script>
<script type="text/javascript" src="lib/respond.min.js"></script>
<script type="text/javascript" src="lib/PIE_IE678.js"></script>
<![endif]-->
<link rel="stylesheet" type="text/css" href="../static/h-ui/css/H-ui.min.css" />
<link rel="stylesheet" type="text/css" href="../static/h-ui.admin/css/H-ui.admin.css" />
<link rel="stylesheet" type="text/css" href="../lib/Hui-iconfont/1.0.7/iconfont.css" />
<link rel="stylesheet" type="text/css" href="../lib/icheck/icheck.css" />
<link rel="stylesheet" type="text/css" href="../static/h-ui.admin/skin/default/skin.css" id="skin" />
<link rel="stylesheet" type="text/css" href="../static/h-ui.admin/css/style.css" />
<!--[if IE 6]>
<script type="text/javascript" src="http://lib.h-ui.net/DD_belatedPNG_0.0.8a-min.js" ></script>
<script>DD_belatedPNG.fix('*');</script>
<![endif]-->
<!--/meta 作为公共模版分离出去-->

<title>采购添加</title>
</head>
<body>
<article class="page-container">
<div class="cl pd-5 bg-1 bk-gray mt-20"> <span class="l"><a class="btn btn-primary radius" onclick="add()" href="javascript:;"><i class="Hui-iconfont">&#xe600;</i> 添加一行</a></span> </div>
	<div class="mt-20">
		<table id="tableList" class="table table-border table-bordered table-bg table-sort">
			<thead>
				<tr class="text-c">
					<th width="70">名称</th>
					<th width="70">单价</th>
					<th width="70">数量</th>
					<th width="70">小计</th>
					<th width="40">操作</th>
				</tr>
			</thead>
			<tbody>
				<tr class="text-c trTotal">
					<td><input type="text" class="input-text" value="" placeholder="采购名称" name="pur_name"></td>
					<td><input type="text" class="input-text" value="" placeholder="采购单价" name="pur_price"></td>
					<td><input type="text" class="input-text" value="" placeholder="采购数量" name="pur_count"></td>
					<td><span class="pur_total"></span></td>
					<td class="c"><button type="button" onclick="deltr(this);" class="btn btn-default radius text-c">删除</button></td>
				</tr>
			</tbody>
		</table>
		<form id="orderForm" class="form form-horizontal">
			<input type="text" id="order_sub" name="order_sub" hidden="hidden"/>

			<div class="row cl">
				<label class="form-label col-xs-4 col-sm-2"><span class="c-red">*</span>采购日期：</label>
				<div class="formControls col-xs-8 col-sm-10">
					<input type="text" onfocus="WdatePicker({maxDate:'%y-%M-%d'})" id="order_date" name="order_date" class="input-text Wdate" >
				</div>
			</div>

			<div class="row cl">
				<label class="form-label col-xs-4 col-sm-2"><span class="c-red">*</span>合作商：</label>
				<div class="formControls col-xs-8 col-sm-10">
					<span class="select-box">
						<select class="select select-option" size="1"  id="order_sup" name="order_sup">
							<option value="">选择合作商</option>
						</select>
					</span>
				</div>
			</div>

			<div class="row cl">
				<label class="form-label col-xs-4 col-sm-2"><span class="c-red">*</span>采购人：</label>
				<div class="formControls col-xs-8 col-sm-10">
					<span class="select-box">
						<select class="select select-option" size="1"  id="order_emp" name="order_emp" >
							<option value="">选择采购人员</option>
						</select>
					</span>
				</div>
			</div>

			<div class="row cl">
				<div class="col-xs-8 col-sm-9 col-xs-offset-4 col-sm-offset-3">
					<button type="submit" class="btn btn-success radius"><i class="icon-ok"></i> 提交</button>
				</div>
			</div>
		</form>
	</div>
</article>


<script type="text/javascript" src="../lib/jquery/1.9.1/jquery.min.js"></script> 
<script type="text/javascript" src="../lib/layer/2.1/layer.js"></script> 
<script type="text/javascript" src="../lib/icheck/jquery.icheck.min.js"></script> 
<script type="text/javascript" src="../lib/jquery.validation/1.14.0/jquery.validate.min.js"></script> 
<script type="text/javascript" src="../lib/jquery.validation/1.14.0/validate-methods.js"></script> 
<script type="text/javascript" src="../lib/jquery.validation/1.14.0/messages_zh.min.js"></script> 
<script type="text/javascript" src="../static/h-ui/js/H-ui.js"></script> 
<script type="text/javascript" src="../static/h-ui.admin/js/H-ui.admin.js"></script> 
<script type="text/javascript" src="../lib/My97DatePicker/WdatePicker.js"></script> 
<script type="text/javascript" src="../lib/datatables/1.10.0/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="../MyJs/jqueryExtend.js"></script>

<script type="text/javascript">
	//添加一行
	function add(){
		var tableTr = '<tr class="text-c trTotal">'
			tableTr += '<td><input type="text" class="input-text" value="" placeholder="采购名称" name="pur_name"></td>'
			tableTr += '<td><input type="text" class="input-text" value="" placeholder="采购单价" name="pur_price"></td>'
			tableTr += '<td><input type="text" class="input-text" value="" placeholder="采购数量" name="pur_count"></td>'
			tableTr += '<td><span class="pur_total"></span></td>'
			tableTr += '<td class="c"><button type="button" onclick="deltr(this);" class="btn btn-default radius text-c">删除</button></td>'
			tableTr += '</tr>'
//		var $tr = $("#clone").clone();
		$(".table>tbody").append(tableTr);
	}

	function deltr(obj){
		$(obj).parents("tr").remove();
	}

    $(document).on('input propertychange', '[name="pur_price"]' , function() { //监听 pur_price 值改变，计算小计
        var pur_price = parseFloat($(this).val()?$(this).val():0);
        var pur_count = parseFloat($(this).parents('.trTotal').find('[name="pur_count"]').val()?$(this).parents('.trTotal').find('[name="pur_count"]').val():0);
        var total = pur_price*pur_count;
        $(this).parents('.trTotal').find('.pur_total').text(total);
    });

    $(document).on('input propertychange','[name="pur_count"]', function() { //监听 pur_count 值改变，计算小计
        var pur_price = parseFloat($(this).parents('.trTotal').find('[name="pur_price"]').val()?$(this).parents('.trTotal').find('[name="pur_price"]').val():0);
        var pur_count = parseFloat($(this).val()?$(this).val():0);
        var total = pur_price*pur_count;
        $(this).parents('.trTotal').find('.pur_total').text(total);
    });
</script>
<script type="text/javascript">
    $(function(){
        $(window).load(function(){
            init();
        });

        $("#orderForm").validate({
            rules:{
                order_date:{
                    required:true,
                },
                order_sup:{
                    required:true,
                },
                order_emp:{
                    required:true,
                },
            },
            onkeyup:false,
            focusCleanup:true,
            success:"valid",
            submitHandler:function(form){
                var orderData = $(form).serializeObject();
                var recordList = new Array();
                $.each($("#tableList tbody tr"),function(i,v){
                    var obj = new Object();
                    obj.pur_name = $(this).find('td > input[name="pur_name"]').val();
                    obj.pur_price = $(this).find('td > input[name="pur_price"]').val();
                    obj.pur_count = $(this).find('td > input[name="pur_count"]').val();
                    obj.pur_total = $(this).find('td > .pur_total').html();
                    recordList[i] = obj;
                });
                var submit = new Object();
                submit.orders = orderData;
                submit.recordList = recordList;
//                console.log(submit);
                $.ajax({
                    type:"POST",
					url:"/yewumanage/caigou/insertCiaGouInfo.do",
					dataType:"json",
					data:JSON.stringify(submit),
					contentType:"application/json",
					success:function (data) {
                        if(data === true){
                            layer.alert("添加成功！",function () {
                                var index = parent.layer.getFrameIndex(window.name);
                                parent.$('.btn-refresh').click();
                                parent.layer.close(index);
                            })
                        }else {
                            layer.msg('添加失败!',{icon:1,time:1000});
                        }
                    },
                    error:function () {
                        layer.msg('添加失败!',{icon:1,time:1000});
                    }
				});
            }
        });
    });

    //初始化方法
    function init(){
        //加载人员
        $.post("/staffing/employee/getEmployeeList.do",function(data){
            $.each(data,function(i,v){
                var $optionPeo = "<option value="+v.emp_id+">"+v.emp_name+"</option>";
                $("#order_emp").append($optionPeo);
            });
        },"json");

        //加载合作商
        $.post("/yewumanage/partner/getPartnerList.do",function(data){
            $.each(data,function(i,v){
                var $option = "<option value="+v.par_id+">"+v.par_name+"</option>";
                $("#order_sup").append($option);
            });
        },"json");
    }
</script>
</body>
</html>